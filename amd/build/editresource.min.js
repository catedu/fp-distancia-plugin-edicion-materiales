define ("local_educaaragon/editresource",["jquery","core/str","core/ajax","core/modal_factory","core/modal_events","core/templates"],function(a,b,c,d,f,g){"use strict";var i={CREATEVERSION:"[data-action=\"createversion\"]",DELETEVERSION:"[data-action=\"deleteversion\"]",LOADVERSION:"[data-action=\"loadversion\"]",SAVECHANGES:"[data-action=\"save-changes\"]",APPLYVERSION:"[data-action=\"apply-version\"]",CHANGEVERSION:"[data-action=\"change-version\"]",PROCESSVERSIONLINKS:"[data-action=\"process-version-links\"]",VIEWVERSIONLINKS:"[data-action=\"viewversionlinks\"]",VIEWVERSIONLINKSEDIT:"[data-action=\"viewversionlinks_link\"]"},j={CREATEVERSION:"local_educaaragon_createversion",DELETEVERSION:"local_educaaragon_deleteversion",SAVECHANGES:"local_educaaragon_savechanges",APPLYVERSION:"local_educaaragon_applyversion",PROCESSVERSIONLINKS:"local_educaaragon_processresourcelinks"},k={CONTENT_CONTROLS:"[data-region=\"educaaragon-editresource\"]",CONTENT_ATTO_HTML:".editor_atto_content",OVERLAY:"[data-region=\"overlay-icon-container\"]"},l={LOADING:"core/overlay_loading",SUCCESS:"core/notification_success",ERROR:"core/notification_error"};function h(b){this.node=a(b);this.initEditResource()}h.prototype.node=null;h.prototype.initEditResource=function(){this.node.find(i.CREATEVERSION).on("click",this.createVersion);this.node.find(i.DELETEVERSION).on("click",this.deleteVersion);this.node.find(i.LOADVERSION).on("click",this.loadVersion);this.node.find(i.SAVECHANGES).on("click",this.saveChanges);this.node.find(i.APPLYVERSION).on("click",this.applyVersion);this.node.find(i.PROCESSVERSIONLINKS).on("click",this.processVersionLinks);this.node.find(i.VIEWVERSIONLINKS).on("click",this.viewVersionLinks);this.changeVersion();a(document).on("change",i.CHANGEVERSION,this.changeVersion)};h.prototype.createVersion=function(h){h.preventDefault();h.stopPropagation();var e=a(h.currentTarget).attr("data-courseid"),i=a(h.currentTarget).attr("data-resourceid"),m=a("#newversion").val(),n=a("[data-region=\"select-asofversion\"]").val();if(n===void 0){n="original"}b.get_strings([{key:"createnewversion",component:"local_educaaragon"},{key:"createnewversion_desc",component:"local_educaaragon"},{key:"confirm",component:"local_educaaragon"},{key:"errorcreateversion",component:"local_educaaragon"}]).then(function(b){var h=b[0],o=b[1],p=b[2],q=b[3];return d.create({title:h,body:o,type:d.types.SAVE_CANCEL}).then(function(b){b.setSaveButtonText(p);b.getRoot().on(f.save,function(){var b={methodname:j.CREATEVERSION,args:{courseid:e,resourceid:i,versionname:m,asofversion:n}};g.render(l.LOADING,{visible:!0}).done(function(d){var e=a(k.CONTENT_CONTROLS);e.append(d);c.call([b])[0].done(function(a){if(!0===a.response){var b=window.location.href;if(-1<b.indexOf("?")){b+="&version="+a.versionname}else{b+="?version="+a.versionname}window.location.href=b}if(!1===a.response){e.html("<div class=\"alert alert-danger\">"+q+"</div>")}}).fail(Notification.exception)})});b.getRoot().on(f.hidden,function(){b.destroy()});return b})}).done(function(a){a.show()}).fail(Notification.exception)};h.prototype.deleteVersion=function(h){h.preventDefault();h.stopPropagation();var e=a(h.currentTarget).attr("data-courseid"),i=a(h.currentTarget).attr("data-resourceid"),m=a("[data-region=\"select-version\"]").val();b.get_strings([{key:"deleteversion",component:"local_educaaragon"},{key:"deleteversion_desc",component:"local_educaaragon"},{key:"confirm",component:"local_educaaragon"}]).then(function(b){var h=b[0],n=b[1],o=b[2];return d.create({title:h,body:n,type:d.types.SAVE_CANCEL}).then(function(b){b.setSaveButtonText(o);b.getRoot().on(f.save,function(){var b={methodname:j.DELETEVERSION,args:{courseid:e,resourceid:i,versionname:m}};g.render(l.LOADING,{visible:!0}).done(function(d){var e=a(k.CONTENT_CONTROLS);e.append(d);c.call([b])[0].done(function(a){if(!0===a.response){location.reload()}}).fail(Notification.exception)})});b.getRoot().on(f.hidden,function(){b.destroy()});return b})}).done(function(a){a.show()}).fail(Notification.exception)};h.prototype.loadVersion=function(b){b.preventDefault();b.stopPropagation();var c=a("[data-region=\"select-version\"]").val(),d=window.location.href;if(-1<d.indexOf("?")){d+="&version="+c}else{d+="?version="+c}window.location.href=d};h.prototype.saveChanges=function(h){h.preventDefault();h.stopPropagation();var i=a(h.currentTarget).attr("data-courseid"),m=a(h.currentTarget).attr("data-resourceid"),n=a(h.currentTarget).attr("data-versionname"),o=a(h.currentTarget).attr("data-filename"),p=a(k.CONTENT_ATTO_HTML).html();b.get_strings([{key:"save_changes",component:"local_educaaragon"},{key:"save_changes_desc",component:"local_educaaragon"},{key:"confirm",component:"local_educaaragon"},{key:"changes_saved",component:"local_educaaragon"},{key:"not_saved",component:"local_educaaragon"},{key:"write_comment",component:"local_educaaragon"}]).then(function(b){var e=b[0],h=b[1],q=b[2],r="<p>"+h+"</p><div class=\"col-xl-12\"><div class=\"form-group purple-border mb-5\"><label for=\"write_comment\" class=\"\">"+b[5]+"</label><textarea maxlength=\"300\" class=\"form-control\" id=\"write_comment\" rows=\"3\"></textarea></div></div>";return d.create({title:e,body:r,type:d.types.SAVE_CANCEL}).then(function(d){d.setSaveButtonText(q);d.getRoot().on(f.save,function(f){f.preventDefault();var e=a("#write_comment").val();if(300<e.length){e=e.substring(0,300)}d.hide();var h={methodname:j.SAVECHANGES,args:{courseid:i,resourceid:m,versionname:n,filename:o,html:p,other:btoa(e)}};g.render(l.LOADING,{visible:!0}).done(function(d){var e=a(k.CONTENT_CONTROLS);e.append(d);c.call([h])[0].done(function(c){var e=new Date;if(!0===c.response){g.render(l.SUCCESS,{message:b[3]+e.toTimeString().split(" ")[0],closebutton:!0,announce:!0}).done(function(b){a(k.CONTENT_CONTROLS).prepend(b)})}else{g.render(l.ERROR,{message:b[4],closebutton:!0,announce:!0}).done(function(b){a(k.CONTENT_CONTROLS).prepend(b)})}a(k.OVERLAY).remove()}).fail(Notification.exception)})});d.getRoot().on(f.hidden,function(){d.destroy()});return d})}).done(function(a){a.show()}).fail(Notification.exception)};h.prototype.applyVersion=function(h){h.preventDefault();h.stopPropagation();var e=a(h.currentTarget).attr("data-courseid"),i=a(h.currentTarget).attr("data-resourceid"),m=a(h.currentTarget).attr("data-versionname");if(m===void 0){m=a("[data-region=\"select-version\"]").val()}b.get_strings([{key:"apply_version",component:"local_educaaragon"},{key:"apply_version_desc",component:"local_educaaragon"},{key:"confirm",component:"local_educaaragon"},{key:"version_saved",component:"local_educaaragon"},{key:"version_not_saved",component:"local_educaaragon"},{key:"versionprintable_saved",component:"local_educaaragon"},{key:"versionprintable_not_saved",component:"local_educaaragon"}]).then(function(b){var h=b[0],n=b[1],o=b[2];return d.create({title:h,body:n,type:d.types.SAVE_CANCEL}).then(function(d){d.setSaveButtonText(o);d.getRoot().on(f.save,function(){var d={methodname:j.APPLYVERSION,args:{courseid:e,resourceid:i,versionname:m}};g.render(l.LOADING,{visible:!0}).done(function(e){var f=a(k.CONTENT_CONTROLS);f.append(e);c.call([d])[0].done(function(c){var e=new Date;if(!0===c.response){g.render(l.SUCCESS,{message:b[3]+e.toTimeString().split(" ")[0],closebutton:!0,announce:!0}).done(function(b){a(k.CONTENT_CONTROLS).prepend(b)})}else{g.render(l.ERROR,{message:b[4],closebutton:!0,announce:!0}).done(function(b){a(k.CONTENT_CONTROLS).prepend(b)})}if(!0===c.responseprintable){g.render(l.SUCCESS,{message:b[5]+e.toTimeString().split(" ")[0],closebutton:!0,announce:!0}).done(function(b){a(k.CONTENT_CONTROLS).prepend(b)})}else{g.render(l.ERROR,{message:b[6],closebutton:!0,announce:!0}).done(function(b){a(k.CONTENT_CONTROLS).prepend(b)})}a(k.OVERLAY).remove()}).fail(Notification.exception)})});d.getRoot().on(f.hidden,function(){d.destroy()});return d})}).done(function(a){a.show()}).fail(Notification.exception)};h.prototype.changeVersion=function(){var b=a("[data-region=\"select-version\"]").val();if("original"===b){a(i.DELETEVERSION).prop("disabled",!0);a(i.LOADVERSION).prop("disabled",!0);a(i.PROCESSVERSIONLINKS).prop("disabled",!0)}else{a(i.DELETEVERSION).prop("disabled",!1);a(i.LOADVERSION).prop("disabled",!1);a(i.PROCESSVERSIONLINKS).prop("disabled",!1)}};h.prototype.processVersionLinks=function(h){h.preventDefault();h.stopPropagation();var e=a(h.currentTarget).attr("data-courseid"),m=a(h.currentTarget).attr("data-resourceid"),n=a(h.currentTarget).attr("data-versionname");if(n===void 0){n=a("[data-region=\"select-version\"]").val()}b.get_strings([{key:"process_version_links",component:"local_educaaragon"},{key:"process_version_links_desc",component:"local_educaaragon"},{key:"confirm",component:"local_educaaragon"},{key:"processed_resource_links",component:"local_educaaragon"},{key:"not_processed_resource_links",component:"local_educaaragon"}]).then(function(b){var o=b[0],p=b[1],q=b[2];return d.create({title:o,body:p,type:d.types.SAVE_CANCEL}).then(function(d){d.setSaveButtonText(q);d.getRoot().on(f.save,function(){var d={methodname:j.PROCESSVERSIONLINKS,args:{courseid:e,resourceid:m,versionname:n}};g.render(l.LOADING,{visible:!0}).done(function(e){var f=a(k.CONTENT_CONTROLS);f.append(e);c.call([d])[0].done(function(c){var e=new Date;if(!0===c.response){g.render(l.SUCCESS,{message:b[3]+e.toTimeString().split(" ")[0],closebutton:!0,announce:!0}).done(function(b){a(k.CONTENT_CONTROLS).prepend(b);var c=a(h.currentTarget).attr("data-resourceid");if(0<a(i.VIEWVERSIONLINKS).length){var d=a(i.VIEWVERSIONLINKS).attr("data-href"),e=a("[data-region=\"select-version\"]").val(),f=d+"?resourceid="+c+"&version="+e,g=window.open(f,"_blank");if(null===g){window.location.href=f}}if(0<a(i.VIEWVERSIONLINKSEDIT).length){var j=a(i.VIEWVERSIONLINKSEDIT).attr("href"),l=window.open(j,"_blank");if(null===l){window.location.href=j}}})}else{g.render(l.ERROR,{message:b[4],closebutton:!0,announce:!0}).done(function(b){a(k.CONTENT_CONTROLS).prepend(b)})}a(k.OVERLAY).remove()}).fail(Notification.exception)})});d.getRoot().on(f.hidden,function(){d.destroy()});return d})}).done(function(a){a.show()}).fail(Notification.exception)};h.prototype.viewVersionLinks=function(b){b.preventDefault();b.stopPropagation();var c=a(b.currentTarget).attr("data-resourceid"),d=a(b.currentTarget).attr("data-href"),e=a("[data-region=\"select-version\"]").val();window.open(d+"?resourceid="+c+"&version="+e)};return{initEditResource:function initEditResource(a){return new h(a)}}});
//# sourceMappingURL=editresource.min.js.map
